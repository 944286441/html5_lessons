<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<title></title>
		<script src="randomNum.js" type="text/javascript" charset="utf-8"></script>
		<script src="collision.js" type="text/javascript" charset="utf-8"></script>
		<script src="loading.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
		    body,html{
		    	height: 100%;
		    	margin: 0;
		    }
		    #myCanvas{
		    	/*background-color: gainsboro;*/
		    }
			#loading{
				position: absolute;
				left: 50%;top: 50%;
				text-align: center;
				transform: translate(-50%,-50%);
				display: none;
			}
			#gameEnd{
				position: absolute;
				z-index: 666;
				top: 0;
				width: 100%;
				height: 100%;
				background: darkgray;
				display: none;
			}
			#warning{
				position: absolute;
				top: 10%;
				left: 10%;
				width: 80%;
				height: 300px;
				background: red;
				background: url("flyBg");
			}
			#inputWrap{
				position: absolute;
				bottom: 20%;
				left: 10%;
				width: 80%;
				height: 140px;
				text-align: center;
				line-height: 60px;
				background: orchid;
			}
			#againPlay{
				width: 100%;
				height: 60px;
				border: 1px solid green;
				font-size: 22px;
				outline: none;
				background: dimgray;
				
			}
			#hiScore{
				width: 100%;
				height: 60px;
				background: dimgray;
				border: 1px solid green;
				font-size: 22px;
				margin-bottom: 20px;
				box-sizing: border-box;
			}
		</style>
	</head>
	<body>
		<canvas id="myCanvas"></canvas>
		<div id="loading">
			<img src="img/loading.gif"/>
			<div id="progress">已加载：0%</div>
		</div>
		<audio loop id="bulletAudio">
			<source src="audio/bullet.mp3" type="audio/mp3"></source>
			<source src="audio/bullet.mp3" type="audio/mp4"></source>
			<source src="audio/bullet.mp3" type="audio/ogg"></source>
		</audio>
		<audio id="gameOverAudio">
			<source src="audio/game_over.mp3" type="audio/mp3"></source>
			<source src="audio/game_over.mp3" type="audio/mp4"></source>
			<source src="audio/game_over.mp3" type="audio/ogg"></source>
		</audio>	
		<audio id="enemy1Audio">
			<source src="audio/enemy1_down.mp3" type="audio/mp3"></source>
			<source src="audio/enemy1_down.mp3" type="audio/mp4"></source>
			<source src="audio/enemy1_down.mp3" type="audio/ogg"></source>
		</audio>
		<audio id="enemy2Audio">
			<source src="audio/enemy2_down.mp3" type="audio/mp3"></source>
			<source src="audio/enemy2_down.mp3" type="audio/mp4"></source>
			<source src="audio/enemy2_down.mp3" type="audio/ogg"></source>
		</audio>
		<audio id="enemy3Audio">
			<source src="audio/enemy3_down.mp3" type="audio/mp3"></source>
			<source src="audio/enemy3_down.mp3" type="audio/mp4"></source>
			<source src="audio/enemy3_down.mp3" type="audio/ogg"></source>
		</audio>	
		
		<div id="gameEnd">
			<div id="warning">
				<span>遗憾</span>
			</div>
			<div id="inputWrap">
				<div id="hiScore">历史分数：</div>
				 <input type="button" id="againPlay" value="开始"/>
				
			   
			</div>
		</div>
	</body>
	
<script type="text/javascript" charset="utf-8">
    var canvas = document.querySelector("#myCanvas");
    var ctx = canvas.getContext("2d");
    
    var loading = document.querySelector("#loading");
    var progress = document.querySelector("#progress");
    var bulletAudio = document.querySelector("#bulletAudio");
    var gameOverAudio = document.querySelector("#gameOverAudio");
    var enemy1Audio = document.querySelector("#enemy1Audio");
    var enemy2Audio = document.querySelector("#enemy2Audio");
    var enemy3Audio = document.querySelector("#enemy3Audio");
    
    bulletAudio.playbackRate = 3;
    bulletAudio.volume = 0.1;
    gameOverAudio.pause();
    
//  enemy1Audio.pause();
//  enemy2Audio.pause();
//  enemy3Audio.pause();
//  enemy1Audio.volume = 1;
    
    //获取屏幕的宽高
    var windowW = document.body.clientWidth;
    var windowH = document.body.clientHeight;
    //等于画布的宽高
    canvas.width = windowW;
    canvas.height = windowH;
    //动画帧
    var frame = 0;
    //子弹存储
    var bulletArr = [];
    //敌机存储
    var enemyArr = [];
    //工具存储
    var ammoArr = [];
    //捡到炸药控制
    var bombControl = false;
    //捡到双排子弹
    var doubleBulletContol = false;
    //控制双排子弹时间
    var doubleNum = 0;
    //捡到无敌包
    var godControl = false;
    //控制无敌时间
    var godNum = 0;
	//开始/暂停
	var startBtn;
	var controlBtn = true;
	
	//积分，打飞机5分，中飞机3，小飞机2分
	var score = 0;
	
	
	

	function gameStart(){ 

	    //加载图片
	    loadingImg({
	    	loadImg:{
	    		bgImage:"img/background.png",
	    		herofly:"img/herofly.png",
	    		bullet1:"img/bullet1.png",
	    		bullet2:"img/bullet2.png",
	    		enemy1:"img/enemy1.png",
	    		enemy2:"img/enemy2.png",
	    		enemy3:"img/enemy3.png",
	    		ammo:"img/prop.png",
	    		bomb:"img/bomb.png",
	    		startBtn:"img/start.png",
	    		pauseBtn:"img/pause.png"
	    		
	    	},
	    	prog:function (num){
	    		imgProgress = num;
	    		console.log(imgProgress);
	    		//num为加载的进度
	    		progress.innerHTML = "已加载：" + imgProgress +"%";
	    	},
	    	//设置回调函数名
	    	complete:init
	    });
	
	    function init(getImages){
	    	loading.style.display = "none";
	    	//开始/暂停进行切换
	    	startBtn = getImages.pauseBtn;
			//炸药图片，用于animation与点击事件；
			var bombImg = getImages.bomb;
			var doubleBulletImg = getImages.bullet2;
			
			
	    	//画背景
	    	var bgImgY = 0;
	    	function bgdraw(){
	    		bgImgY +=3;
	    		if(bgImgY >= windowH){
	    			bgImgY = 0;
	    		}
	    		//画两张图片
	    		ctx.drawImage(getImages.bgImage, 0, bgImgY, windowW, windowH);
				ctx.drawImage(getImages.bgImage, 0, bgImgY-windowH, windowW, windowH); 		
	    	}
	    	
	//--------------------------------------------------------------------------------------------------
	    	//画玩家飞机
	    	var herofly = {
	    		//图片为img元素，非src,可以直接获取宽高
	    		heroFlyW : getImages.herofly.width/5,
	    		heroFlyH : getImages.herofly.height,
	    		heroFlyX : windowW/2 - (getImages.herofly.width/10),
	    		heroFlyY : windowH - getImages.herofly.height - 20,
	    		heroFlyImg : getImages.herofly,
	    		heroFlyImgX : 0,
	    		imgXChange : true,
	    		//判断玩家飞机爆炸的属性
	    		heroFlyBomb : false,
	    		//玩家爆炸后监控爆炸过程(切换图片)；
	    		heroFlyNum : 0
	    	}
	    	//切换飞机的方法
	    	herofly.change = function(){
	    		//若飞机撞击则结束阻止切换
	    		if(!this.heroFlyBomb){
		    		if(this.imgXChange){
		    			this.heroFlyImgX = 0;
		    			this.imgXChange = false;
		    		}else{
		    			this.heroFlyImgX = this.heroFlyW;
		    			this.imgXChange = true;
		    		}
	    		}
	    	}
	    	//绘制飞机的方法
	    	herofly.draw = function(){
	    		this.heroFlyNum ++;
	    		if(this.heroFlyNum % 2 == 0){
	    			//先调用方法，在判断是否清除完毕，同敌机自毁类似；
	    			var bomb = this.gameOver();
	    			if(bomb){
	    				return true;
	    				
	    			}
	    		}
	    		
	    		ctx.drawImage(this.heroFlyImg, this.heroFlyImgX, 0, this.heroFlyW, this.heroFlyH, this.heroFlyX, this.heroFlyY, this.heroFlyW, this.heroFlyH);
	    	}
	    	//玩家飞机撞敌机-爆炸方法
	    	herofly.gameOver = function(){
	    		//如飞机爆炸属性为false,飞机不会启动爆炸程序
	    		if(this.heroFlyBomb){
	    			this.heroFlyImgX +=this.heroFlyW;
	    			if(this.heroFlyImgX >= this.heroFlyImg.width){
	    				return true;
	    			}
	    		}
	    	}
	//=-----------------------------------------------------------------------------   
			//绘制子弹
	    	function Bullet(){
	    		if(doubleBulletContol){
	    			this.bulletImg = doubleBulletImg;
	
	    		}else{
	    			this.bulletImg = getImages.bullet1;
	    		}
	    		this.bulletW = this.bulletImg.width;   
	    		this.bulletH = getImages.bullet1.height;
	    		this.bulletX = herofly.heroFlyX + (herofly.heroFlyW/2 - (this.bulletImg.width/2)); 
	    		this.bulletY = herofly.heroFlyY;
	
	    		this.bulletSpped = 10;
	    		//子弹的攻击力
	    		this.atk = 1;
	    		
	    	}
	    	//绘制子弹的方法
	    	Bullet.prototype.drawBullet = function(){
	    		ctx.drawImage(this.bulletImg,this.bulletX,this.bulletY,this.bulletW,this.bulletH);
	    	}
	    	//子弹移动动方法
	    	Bullet.prototype.bulletMove = function(){
	    		this.bulletY -= this.bulletSpped;
	    		//子弹自毁
	    		if(this.bulletY <= -this.bulletH){
	    			var bulletIndex = bulletArr.indexOf(this);
	    			bulletArr.splice(bulletIndex, 1);
	    			return true;
	    		}else{
	    			return false;
	    		}
	    		
	    	}
	    	//子弹碰撞敌机后，子弹自毁的方法
	    	Bullet.prototype.destruct = function(){
	    		bulletArr.splice(bulletArr.indexOf(this), 1);
	    	}
	//-----------------------------------------------------------------------    	
	    	//绘敌机
	    	function Enemy(){
	    		//三种机型 大、中、小
	    		//敌机速度  控制整体移动速度;
	    		this.enemyInitSpeed = 0;
	    		//随机出现敌机的概率
	    		var randomValue = randomNum(0,100);
	    		//小飞机
	    		if(randomValue <70){
	    			this.hp = 1;
	    			this.img = getImages.enemy1;
	    			this.imgNum = 5;
	    			this.speed = randomNum(3+this.enemyInitSpeed, 5+this.enemyInitSpeed);
	    			
	    		}
	    		else if(randomValue>=70 && randomValue<95){
	    			this.hp = 4;
	    			this.img = getImages.enemy2;
	    			this.imgNum =6;
	    			this.speed = randomNum(2+this.enemyInitSpeed, 3+this.enemyInitSpeed);    			
	    		}
	    		else{
	    			this.hp = 8;
	    			this.img = getImages.enemy3;
	    			this.imgNum = 10;
	    			this.speed = randomNum(1+this.enemyInitSpeed, 2+this.enemyInitSpeed);    			
	    		}
	    		//公共属性
	    		this.enemyW = this.img.width/this.imgNum;
	    		this.enemyH = this.img.height;
	    		this.enemyX = randomNum(0, windowW-this.enemyW);
	    		this.enemyY = -this.enemyH;
	    		//保持图片X轴可变，可以切换敌机图片，渲染出爆炸效果；
	    		this.enemyImgX = 0;
	    		this.jugdeBomb = false;
	    		
	    		//计数器
	    		this.num = 0;
	    	}
	    	//绘制敌机的方法
	    	Enemy.prototype.drawEnemy = function(){
	    		this.num++;
	    		//每刷2遍没血飞机变化一次x轴
	    		if(this.num % 3 ==0){
	    			//调用爆炸方法， 如果为真则敌机已全部清除;
	    			if(this.enemyBomb()){
	    				
						if(this.img == getImages.enemy1){
			    			score += 2;
			    		}else if(this.img == getImages.enemy2){
			    			score += 3;
			    		}else if(this.img == getImages.enemy3){
			    			score += 5;
			    		}
			    		return true;
	    			}
	    		}
	    		ctx.drawImage(this.img, this.enemyImgX, 0, this.enemyW, this.enemyH, this.enemyX, this.enemyY, this.enemyW, this.enemyH);
	    	}
	    	//敌机移动的方法
	    	Enemy.prototype.enemyMove = function(){
	    		//如果敌机血量为零，停止移动，开始自毁程序
	    		if(!this.jugdeBomb){
		    		this.enemyY += this.speed;
		    		if(this.enemyY >= windowH){
		    			var enemyIndex = enemyArr.indexOf(this);
		    			enemyArr.splice(enemyIndex, 1);
		    			return true;
		    		}else{
		    			return false;
		    		}
	    		}
	    	}
	    	//敌机爆炸的方法
	    	Enemy.prototype.enemyBomb = function(){
	    		//判断是否飞机没血了
	    		if(this.jugdeBomb){
	    			//开始播放爆炸图片
	    			this.enemyImgX += this.enemyW;
	    			if(this.enemyImgX >= this.img.width){
	    				enemyArr.splice(enemyArr.indexOf(this),1);
						return true;
	    			}
	    		}
	    	}
	    	//敌机扣血
	    	Enemy.prototype.enemyDownHp = function(atk){
	    		this.hp -= atk;
	    		if(this.hp <= 0){
	    			//通过改变属性，来判断飞机已经没血，再通过属性来使飞机消失；
	    			//如果直接增加图片x轴坐标,虽然飞机没血，只是条件成立了，绘飞机(飞机消失)有过程，之后子弹和飞机碰撞一次才能变化一张图片
	    			this.jugdeBomb = true;
	// 				this.enemyImgX += this.enemyW;
	//  			if(this.enemyImgX >= this.img.width){
	//  				enemyArr.splice(enemyArr.indexOf(this),1);
	//					return true;
	//  			}
	    		}
			}  
	//----------------------------------------------------------------------------
			//绘弹药
			function Ammo(){
				//三种弹药
				var rand = randomNum(0,100);
				this.img = getImages.ammo;
				//炸药
				if(rand<50){
					this.id = 0;
				}
				//双排子弹
				else if(rand>=50 && rand<=90){
					this.id = 1;
				}
				//无敌
				else{
					this.id = 2;
				}
				//公共属性
	    		this.ammoW = this.img.width/3;
	    		this.ammoH = this.img.height;
	    		this.ammoX = randomNum(0, windowW-this.ammoW);
	    		this.ammoY = -this.ammoH;
	    		//背景图片的x坐标
	    		this.ammoImgX = this.id*this.ammoW;
	    		this.speed = 5;
			}
			//弹药绘制的方法
			Ammo.prototype.drawAmmo = function(){
				ctx.drawImage(this.img, this.ammoImgX, 0, this.ammoW, this.ammoH,this.ammoX, this.ammoY, this.ammoW, this.ammoH);
			}
			//弹药移动的方法
			Ammo.prototype.ammoMove = function(){
				this.ammoY += this.speed;
				//如果弹药超出画布则移除
				if(this.ammoY >= windowH){
					ammoArr.splice(ammoArr.indexOf(this), 1);
					return true;
				}
			}
			
			//开始/暂停按钮
			function startOrPause(){
				ctx.drawImage(startBtn, 10, windowH-50, 40, 40);
			}
			//分数方法
			function scoreTotal(){
				ctx.font = "20px 微软雅黑";
				ctx.fillText("分数: "+score, windowW/2-20, 30);
				ctx.fill();
			}
			//无敌时间函数
			function godTime(){
				ctx.font = "20px 微软雅黑";
				ctx.fillText("无敌时间: "+godNum, 10, 30);
				ctx.fill();
			}

	//------------------------------------------------------------------------    	
	    	var animationId;
	    	//动画开始
	    	function planeAnimation(){
	    		//动画帧每刷新一次增加，监控
	    		frame++;
	    		//清画布
	    		ctx.clearRect(0, 0, windowW, windowH);
	    		
	    		//渲染背景
	    		bgdraw();
	    		
		  	 	//渲染子弹
		  	 	if(frame % 5 == 0){
		  	 		var bullets = new Bullet();
		  	 		bulletArr.push(bullets);
		  	 	}
		  	 	for(let i=0; i<bulletArr.length; i++){
		  	 		bulletArr[i].drawBullet();
		  	 		if(bulletArr[i].bulletMove()){
		  	 			i--;
		  	 		}
		  	 	}
		  	 //------------------------------	
		  	 	//渲染飞机
	    		if(frame % 5 == 0){
	    			herofly.change();
	    		}
	    		var gameOver = herofly.draw();
	//  		if(gameOver){
	//  			alert("游戏结束");
	//  		}
	    		
	    	//----------------------------------	
				//渲染敌机
				if(frame % 100 == 0){
					//决定飞机的多少
					var enemyPlane = new Enemy();
					enemyArr.push(enemyPlane);
				}
				for(let i=0; i<enemyArr.length; i++){
					//画敌机
					var enemyDisplay =  enemyArr[i].drawEnemy();
					if(enemyDisplay){
						i--;
						//如果清除，跳过这个飞机，开始遍历下一个飞机
						continue;
					}
					
					//敌机移动
					if(enemyArr[i].enemyMove()){
						i--;
					}
				}
		  	 	
		  	 	//子弹碰撞敌机
		  	 	for(let i=0; i<bulletArr.length; i++){
		  	 		for(let j=0; j<enemyArr.length; j++){
		  	 			//每颗子弹与所有敌机进行匹对，若满足条件则爆炸;
		  	 			var bombEasing = collide(bulletArr[i], enemyArr[j]);
		  	 			if(bombEasing){
		  	 				//渲染敌机爆炸并消失,碰撞的敌机调用downHp方法
		  	 				enemyArr[j].enemyDownHp(bulletArr[i].atk);
		  	 				//子弹自毁
		  	 				bulletArr[i].destruct();
		  	 				i--;
		  	 				break;
		  	 			}
		  	 		}
		  	 	}
		  	 	//玩家碰撞敌机
		  	 	for(let i=0; i<enemyArr.length; i++){
		  	 		if(!godControl){
			  	 		if(collideHeroFly(herofly, enemyArr[i])){
			  	 			herofly.heroFlyBomb = true;
			  	 			gameOverAudio.play();
			  	 		}
		  	 		}
		  	 	}
		  	 	
		  	 	//-----------------------------
		  	 	//渲染弹药
		  	 	if(frame % 200 == 0){
		  	 		var ammo = new Ammo();
		  	 		ammoArr.push(ammo);
		  	 	}
		  	 	//渲染炸弹并判断何种炸弹
		  	 	for(let i=0; i<ammoArr.length; i++){
		  	 		if(collideAmmo(herofly, ammoArr[i])){
		  	 			//捡到炸药
		  	 			if(ammoArr[i].id == 0){
		  	 				bombControl = true;
		  	 				enemy1Audio.play();
		  	 			}
		  	 			//捡到双排
		  	 			if(ammoArr[i].id == 1){
			  	 			doubleBulletContol = true;
			  	 			enemy2Audio.play();
			  	 			
		  	 			}
		  	 			//捡到无敌
		  	 			if(ammoArr[i].id == 2){
		  	 				godControl = true;
		  	 				enemy3Audio.play();
		  	 			}
		  	 			
		  	 			ammoArr.splice(i, 1);
		  	 			i--;
		  	 			//跳过本次循环
		  	 			continue;
		  	 		}	
		  	 		
		  	 		ammoArr[i].drawAmmo();
		  	 		if(ammoArr[i].ammoMove()){
		  	 			i--;	
		  	 		}
		  	 	}
		  	 	//放置炸药
		  	 	if(bombControl){
					ctx.drawImage(bombImg, windowW-bombImg.width-20, windowH-bombImg.height-20, bombImg.width, bombImg.height);
		  	 	}
		  	 	//--------------------------------------------
		  	 	//控制双排子弹的时间
		  	 	if(doubleBulletContol){
		  	 		doubleNum++;
		  	 		if(doubleNum<=200){
			  	 		for(let i=0; i<bulletArr.length; i++){
			  	 			bulletArr[i].atk = 4;
			  	 		}
		  	 		}else{
		  	 			doubleBulletContol = false;
		  	 			doubleNum = 0;
		  	 		}
		  	 	}
		  	 	//----------------------------
		  	 	//控制无敌时间
		  	 	if(godControl){
		  	 		godNum++;
		  	 		if(godNum<=400){
			  	 		for(let i=0; i<bulletArr.length; i++){
			  	 			bulletArr[i].atk = 4;
			  	 		}
		  	 		}else{
		  	 			godControl = false;
		  	 			godNum = 0;
		  	 		}
		  	 	}	  	 	
		  	 	//无敌时间计时;
		  	 	if(godControl){
		  	 		godTime();
		  	 	}
		  	 	//----------------------------------
		  	 	//开始/暂停
		  	 	startOrPause();
		  	 	
		  	 	//音频
		  	 	bulletAudio.play();
		  	 	//分数统计
		  	 	scoreTotal();
		  	 	
				if(frame>10000){
					frame = 0;
				}
	    		animationId = window.requestAnimationFrame(planeAnimation);
	    	}
	    	
	    	planeAnimation();
	    	
	    	
	    	
	//---------------------------------------------------------------
			document.addEventListener("touchstart", function (ele){
				//得到初始手指的宽高
				var initPoint = ele.touches[0];
				var initX = initPoint.clientX;
				var initY = initPoint.clientY;
				//得到变量(目的是获得飞机随手指点到的位置移动，而不是飞机的原始坐标)
				var variateX = initX - herofly.heroFlyX;
				var variateY = initY - herofly.heroFlyY;
				//移动
				if (initX>herofly.heroFlyX&&initX<herofly.heroFlyX+herofly.heroFlyW&&initY>herofly.heroFlyY&&initY<herofly.heroFlyY+herofly.heroFlyH){
					document.addEventListener("touchmove", function (e){
						var newPoint = e.touches[0];
						var newX = newPoint.clientX - variateX;
						var newY = newPoint.clientY - variateY;
						//飞机得到新的坐标
						herofly.heroFlyX = newX;
						herofly.heroFlyY = newY;
						
						ctx.drawImage(herofly.heroFlyImg, herofly.heroFlyImgX, 0, herofly.heroFlyW, herofly.heroFlyH, herofly.heroFlyX, herofly.heroFlyY, herofly.heroFlyW, herofly.heroFlyH);
					}, false)
				}
				
				
				//点击炸药，敌机全歼灭
				if(bombControl){
					if(initX>=windowW-bombImg.width-20 && initY>=windowH-bombImg.height-20 && initX<=windowW-20 && initY<=windowH-20){
						for(let i=0; i<=enemyArr.length; i++){
							enemyArr[i].enemyDownHp(1000);
							bombControl = false;						
						}
					}
				}
				//点击开始/暂停进行切换
				if(initX>=10 && initY>=windowH-40 && initX<=80 && initY<=windowH-10){
					if(controlBtn){
						startBtn = getImages.startBtn;
						window.cancelAnimationFrame(animationId);	
						
						startOrPause();	
						bulletAudio.pause();
						controlBtn = false;
					}else{
						window.requestAnimationFrame(planeAnimation);
						startBtn = getImages.pauseBtn;
						controlBtn = true;
					}
					
				}
				
				
			}, false)		
	    }
	}
	
	
	ctx.font = "20px 微软雅黑";
	var fontW = windowW/2;
	var fontH = windowH/2;
	ctx.fillText("开始",fontW,fontH,60);
	ctx.fill();
	var judgeStart = true;
	document.addEventListener("touchstart", function (ele){
		//得到初始手指的宽高
		var initPoint = ele.touches[0];
		var initX = initPoint.clientX;
		var initY = initPoint.clientY;
		if(initX>=fontW && initY>=fontH-20 && initX<=fontW+60 && initY<=fontH&&judgeStart){
			gameStart();
			judgeStart = false;
			loading.style.display = "block";
		}
			
	},false);
</script>
</html>
